<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Narayana School West Bengal - AI Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #0054a6;
        }

        body {
            font-family: 'Roboto', sans-serif;
            
            /* --- NEW: CATCHY ANIMATED MESH GRADIENT --- */
            background-color: #e0f2fe;
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,0) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,0) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,0) 0, transparent 50%);
            background: 
                radial-gradient(at 40% 20%, hsla(215,98%,61%,1) 0px, transparent 50%),
                radial-gradient(at 80% 0%, hsla(189,100%,56%,1) 0px, transparent 50%),
                radial-gradient(at 0% 50%, hsla(355,100%,93%,1) 0px, transparent 50%),
                radial-gradient(at 80% 50%, hsla(340,100%,76%,1) 0px, transparent 50%),
                radial-gradient(at 0% 100%, hsla(22,100%,77%,1) 0px, transparent 50%),
                radial-gradient(at 80% 100%, hsla(242,100%,70%,1) 0px, transparent 50%),
                radial-gradient(at 0% 0%, hsla(343,100%,76%,1) 0px, transparent 50%);
            
            background-size: 200% 200%;
            animation: aurora 15s ease infinite;

            height: 100dvh; 
            width: 100%;
            overflow: hidden;
        }

        @keyframes aurora {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Enhanced Glassmorphism for Chat Card */
        .glass-panel {
            background: rgba(255, 255, 255, 0.7); /* 70% opacity white */
            backdrop-filter: blur(20px) saturate(180%); /* Heavy blur for "Frosted" look */
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }

        /* Floating Icons */
        .floating-icon {
            position: absolute;
            color: rgba(255, 255, 255, 0.6); 
            font-size: 3rem;
            pointer-events: none;
            z-index: 0;
            text-shadow: 0 4px 6px rgba(0,0,0,0.1);
            animation: floatUp linear infinite;
        }

        @keyframes floatUp {
            0% { transform: translateY(110vh) rotate(0deg); opacity: 0; }
            10% { opacity: 0.8; }
            90% { opacity: 0.8; }
            100% { transform: translateY(-10vh) rotate(360deg); opacity: 0; }
        }

        h1, h2, .font-header { font-family: 'Poppins', sans-serif; }
        .chat-scroll::-webkit-scrollbar { width: 6px; }
        .chat-scroll::-webkit-scrollbar-track { background: transparent; }
        .chat-scroll::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 4px; }
        .chat-scroll { scroll-behavior: smooth; }

        .prose p { margin-bottom: 0.5rem; }
        .prose strong { font-weight: 700; color: #1e3a8a; }
        
        .dot-flashing {
            position: relative; width: 8px; height: 8px; border-radius: 5px;
            background-color: var(--primary-color); color: var(--primary-color);
            animation: dot-flashing 1s infinite linear alternate; animation-delay: 0.5s;
        }
        .dot-flashing::before, .dot-flashing::after {
            content: ''; display: inline-block; position: absolute; top: 0;
            width: 8px; height: 8px; border-radius: 5px; background-color: var(--primary-color);
            animation: dot-flashing 1s infinite alternate;
        }
        .dot-flashing::before { left: -12px; animation-delay: 0s; }
        .dot-flashing::after { left: 12px; animation-delay: 1s; }
        @keyframes dot-flashing { 0% { background-color: var(--primary-color); } 50%, 100% { background-color: rgba(0, 84, 166, 0.2); } }

        .mode-btn { transition: all 0.3s ease; }
        .mode-active {
            background: linear-gradient(90deg, #0054a6, #3b82f6);
            color: white !important; border: none;
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.4);
        }
        .user-bubble {
            background: linear-gradient(135deg, #0054a6, #2563eb);
            color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="flex flex-col relative">

    <div id="floating-icons-container" class="absolute inset-0 overflow-hidden pointer-events-none"></div>

    <header class="bg-white/80 backdrop-blur-md shadow-lg z-20 flex-shrink-0 border-b border-white/40">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <img 
                    id="header-logo"
                    src="Untitled.png" 
                    alt="School Logo" 
                    class="h-12 w-12 object-contain rounded-full border-2 border-yellow-400 shadow-sm bg-white"
                >
                <div>
                    <h1 class="text-xl md:text-2xl font-bold tracking-wide text-[#0054a6] drop-shadow-sm">NARAYANA SCHOOL</h1>
                    <p class="text-[10px] md:text-xs text-yellow-600 font-semibold tracking-wider uppercase">West Bengal &bull; Estd. 1979</p>
                </div>
            </div>
            <div class="hidden md:block text-[#0054a6] opacity-90 drop-shadow-sm">
                <a href="https://www.narayanaschools.in/west-bengal/uttar-dinajpur-raiganj">
                <i class="ph ph-student text-3xl"></i></a>
            </div>
        </div>
        <div class="h-1.5 w-full bg-gradient-to-r from-yellow-400 via-orange-400 to-red-400"></div>
    </header>

    <main class="flex-1 container mx-auto p-2 md:p-6 max-w-5xl flex flex-col min-h-0 relative z-10">
        
        <div class="glass-panel flex-1 md:rounded-3xl flex flex-col overflow-hidden relative min-h-0 transition-all duration-300">
            
            <div class="absolute inset-0 flex items-center justify-center pointer-events-none z-0">
                <img 
                    id="bg-watermark"
                    src="Untitled.png" 
                    alt="Watermark" 
                    class="w-2/3 md:w-1/3 opacity-[0.08] grayscale mix-blend-multiply"
                >
            </div>

            <div class="bg-white/40 border-b border-white/50 p-3 md:p-4 flex items-center justify-between relative z-10 flex-shrink-0 backdrop-blur-sm">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white shadow-lg ring-2 ring-white">
                        <i class="ph ph-robot text-2xl"></i>
                    </div>
                    <div>
                        <h2 class="font-bold text-gray-800 text-sm md:text-base">Narayana School Assistant</h2>
                        <p class="text-xs text-green-700 flex items-center gap-1 font-bold bg-green-100 px-2 py-0.5 rounded-full inline-block">
                            <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span> Online
                        </p>
                    </div>
                </div>
                <button onclick="clearChat()" class="text-gray-500 hover:text-red-500 transition p-2 hover:bg-white/80 rounded-full shadow-sm" title="Clear Chat">
                    <i class="ph ph-trash text-xl"></i>
                </button>
            </div>

            <div id="chat-history" class="flex-1 overflow-y-auto p-4 space-y-6 chat-scroll relative z-10 min-h-0">
                <div class="flex gap-4 fade-in">
                    <div class="w-8 h-8 rounded-full bg-[#0054a6] flex-shrink-0 flex items-center justify-center text-white text-xs font-bold shadow-md ring-2 ring-white">N</div>
                    <div class="flex flex-col gap-1 max-w-[85%]">
                        <span class="text-xs text-gray-600 ml-1 font-semibold">Assistant</span>
                        <div class="bg-white/90 text-gray-800 p-4 rounded-2xl rounded-tl-none shadow-sm border border-white/50 prose text-sm md:text-base backdrop-blur-sm">
                            <p><strong>Namaste!</strong> Welcome to your new Narayana AI Support.</p>
                            <p>I can help you solve problems or even <strong>generate images</strong> for your projects. Ask me anything!</p>
                        </div>
                         <button onclick="speakText(this)" class="self-start text-gray-500 hover:text-[#0054a6] text-xs flex items-center gap-1 mt-1 transition px-2 py-1 rounded hover:bg-white/50 font-medium">
                            <i class="ph ph-speaker-high text-lg"></i> Listen
                        </button>
                    </div>
                </div>
            </div>

            <div id="image-preview-area" class="image-preview-container relative z-10 flex-shrink-0 bg-white/60 backdrop-blur-md" style="display:none; padding: 8px 16px; border-top: 1px solid rgba(255,255,255,0.5);">
                <div class="inline-flex items-center gap-2 bg-white border border-gray-200 rounded-lg px-3 py-1.5 shadow-sm">
                    <img id="image-preview-thumb" src="" alt="Preview" class="h-10 w-10 object-cover rounded-md">
                    <span id="image-name" class="text-xs text-gray-600 truncate max-w-[150px] font-medium">image.png</span>
                    <button onclick="clearImage()" class="text-gray-400 hover:text-red-500 ml-2">
                        <i class="ph ph-x-circle text-lg"></i>
                    </button>
                </div>
            </div>

            <div class="px-4 py-2 bg-white/40 flex gap-2 relative z-10 flex-shrink-0 text-xs font-medium backdrop-blur-sm">
                <button id="mode-chat" onclick="setMode('chat')" class="mode-btn mode-active flex items-center gap-2 px-4 py-2 rounded-full border border-white/50 text-gray-600 bg-white/80 shadow-sm">
                    <i class="ph ph-chat-circle-dots text-lg"></i> Chat
                </button>
                <button id="mode-image" onclick="setMode('image')" class="mode-btn flex items-center gap-2 px-4 py-2 rounded-full border border-white/50 text-gray-600 bg-white/80 hover:bg-white shadow-sm">
                    <i class="ph ph-magic-wand text-lg"></i> Generate Image
                </button>
            </div>

            <div class="p-3 md:p-4 bg-white/80 border-t border-white/50 relative z-10 flex-shrink-0 backdrop-blur-md">
                <div class="relative flex items-end gap-2 bg-white/50 border border-white/60 rounded-3xl p-2 focus-within:ring-2 focus-within:ring-[#0054a6] focus-within:border-transparent transition shadow-inner">
                    
                    <input type="file" id="image-upload" accept="image/*" class="hidden" onchange="handleImageSelect(event)">
                    
                    <button onclick="document.getElementById('image-upload').click()" class="text-gray-500 hover:text-[#0054a6] p-2.5 rounded-full hover:bg-white transition" title="Upload Image">
                        <i class="ph ph-paperclip text-xl"></i>
                    </button>

                    <textarea 
                        id="user-input"
                        rows="1"
                        placeholder="Type your message..." 
                        class="w-full bg-transparent border-none focus:ring-0 resize-none max-h-24 py-3 px-2 text-gray-800 placeholder-gray-500 text-sm md:text-base font-medium"
                        oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"
                        onkeydown="handleEnter(event)"
                    ></textarea>
                    
                    <button 
                        id="mic-btn"
                        onclick="toggleSpeechRecognition()"
                        class="text-gray-500 hover:text-[#0054a6] p-2.5 rounded-full hover:bg-white transition"
                        title="Voice Input"
                    >
                        <i class="ph ph-microphone text-xl"></i>
                    </button>

                    <button 
                        id="send-btn" 
                        onclick="handleSend()"
                        class="bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white p-3 rounded-2xl shadow-lg transform active:scale-95 transition-all duration-200 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed mb-0.5"
                    >
                        <i class="ph ph-paper-plane-right text-xl font-bold"></i>
                    </button>
                </div>
                <p class="text-center text-[10px] text-gray-600 mt-2 font-medium opacity-80">
                    Powered by the Department of Computer Science & AI, Narayana School Raiganj.
                </p>
            </div>
        </div>
    </main>

    <script>
        const apiKey = "AIzaSyArBSuQZ8oNzD7NJdYd7ru988J37mtSSlM"; 

        const chatHistory = document.getElementById('chat-history');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const micBtn = document.getElementById('mic-btn');
        const imagePreviewArea = document.getElementById('image-preview-area');
        const imagePreviewThumb = document.getElementById('image-preview-thumb');
        const imageNameSpan = document.getElementById('image-name');
        
        let isGenerating = false;
        let currentImageBase64 = null;
        let currentImageMimeType = null;
        let recognition = null; 
        let isListening = false;
        let currentMode = 'chat';

        // --- UNIQUE FEATURE: Floating Background Icons ---
        function createFloatingIcons() {
            const container = document.getElementById('floating-icons-container');
            const icons = ['üìö', 'üìê', 'üî¨', 'üéì', 'üí°', 'üåç', '‚ûó', '‚öõÔ∏è', 'üß¨', 'üî≠'];
            const count = 20; 
            for (let i = 0; i < count; i++) {
                const span = document.createElement('span');
                span.classList.add('floating-icon');
                span.textContent = icons[Math.floor(Math.random() * icons.length)];
                span.style.left = Math.random() * 100 + 'vw';
                span.style.animationDuration = (Math.random() * 15 + 15) + 's';
                span.style.animationDelay = (Math.random() * 5) + 's';
                span.style.fontSize = (Math.random() * 2 + 1.5) + 'rem';
                container.appendChild(span);
            }
        }
        createFloatingIcons();

        // --- Mode Switching ---
        function setMode(mode) {
            currentMode = mode;
            const chatBtn = document.getElementById('mode-chat');
            const imgBtn = document.getElementById('mode-image');
            [chatBtn, imgBtn].forEach(btn => btn.classList.remove('mode-active'));
            if(mode === 'chat') {
                chatBtn.classList.add('mode-active');
                userInput.placeholder = "Type your message...";
            } else {
                imgBtn.classList.add('mode-active');
                userInput.placeholder = "Describe the image to generate...";
            }
            userInput.focus();
        }

        // --- Speech to Text ---
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = true; recognition.interimResults = true; recognition.lang = 'en-US';
            recognition.onstart = () => { isListening = true; micBtn.classList.add('text-red-500', 'bg-red-50'); userInput.placeholder = "Listening..."; };
            recognition.onend = () => { isListening = false; micBtn.classList.remove('text-red-500', 'bg-red-50'); userInput.placeholder = currentMode === 'chat' ? "Type your message..." : "Describe image..."; };
            recognition.onresult = (event) => {
                let finalTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) finalTranscript += event.results[i][0].transcript + ' ';
                }
                if (finalTranscript) userInput.value = (userInput.value + finalTranscript).trim() + ' ';
                userInput.style.height = 'auto'; userInput.style.height = userInput.scrollHeight + 'px';
            };
        }
        function toggleSpeechRecognition() {
            if (!recognition) return alert("Browser not supported.");
            isListening ? recognition.stop() : recognition.start();
        }

        // --- TTS ---
        function speakText(btnElement) {
            const isPlaying = btnElement.classList.contains('speaking');
            window.speechSynthesis.cancel();
            document.querySelectorAll('.speaking').forEach(btn => {
                btn.classList.remove('speaking', 'text-red-500', 'bg-red-50'); 
                btn.classList.add('text-gray-400');
                btn.innerHTML = '<i class="ph ph-speaker-high text-lg"></i> Listen';
            });
            if (isPlaying) return;
            const msg = btnElement.previousElementSibling; if (!msg) return;
            const utterance = new SpeechSynthesisUtterance(msg.innerText.replace(/[*#_`]/g, ''));
            utterance.lang = 'en-US';
            utterance.onend = () => {
                btnElement.classList.remove('speaking', 'text-red-500', 'bg-red-50');
                btnElement.classList.add('text-gray-400');
                btnElement.innerHTML = '<i class="ph ph-speaker-high text-lg"></i> Listen';
            };
            btnElement.classList.add('speaking', 'text-red-500', 'bg-red-50');
            btnElement.classList.remove('text-gray-400');
            btnElement.innerHTML = '<i class="ph ph-stop-circle text-lg"></i> Stop';
            window.speechSynthesis.speak(utterance);
        }

        // --- Image Upload ---
        function handleImageSelect(event) {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                imagePreviewThumb.src = e.target.result; imageNameSpan.textContent = file.name;
                imagePreviewArea.style.display = 'inline-flex';
                currentImageBase64 = e.target.result.split(',')[1]; currentImageMimeType = file.type;
            };
            reader.readAsDataURL(file);
        }
        function clearImage() {
            document.getElementById('image-upload').value = ''; currentImageBase64 = null; currentImageMimeType = null;
            imagePreviewArea.style.display = 'none';
        }

        // --- Chat Logic ---
        function handleEnter(e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); } }
        async function handleSend() {
            if(isListening && recognition) recognition.stop();
            const text = userInput.value.trim();
            if ((!text && !currentImageBase64) || isGenerating) return;

            userInput.value = ''; userInput.style.height = 'auto'; isGenerating = true; sendBtn.disabled = true;
            appendMessage('user', text, currentImageBase64 ? imagePreviewThumb.src : null);
            
            if (currentMode === 'image') {
                const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(text)}?nologo=true`;
                const loadingId = appendLoading();
                setTimeout(() => {
                    removeLoading(loadingId); appendMessage('bot', `Generated image for: **"${text}"**`, imageUrl);
                    isGenerating = false; sendBtn.disabled = false;
                }, 1500);
                clearImage(); return;
            }

            const tempImage = currentImageBase64; const tempMime = currentImageMimeType; clearImage(); 
            const loadingId = appendLoading();
            try {
                const response = await generateContentWithRetry(text, tempImage, tempMime);
                removeLoading(loadingId); appendMessage('bot', response);
            } catch (error) {
                console.error(error); removeLoading(loadingId); appendMessage('bot', "**System Error:** Check connection.");
            } finally {
                isGenerating = false; sendBtn.disabled = false;
            }
        }

        function appendMessage(role, text, imageUrl = null) {
            const wrapper = document.createElement('div'); wrapper.className = 'flex gap-4 fade-in mb-4';
            let contentHtml = '';
            if (imageUrl) {
                const isGen = imageUrl.startsWith('http');
                contentHtml += `<div class="mb-2"><img src="${imageUrl}" class="${isGen ? "w-full max-w-sm rounded-xl border-4 border-white shadow-lg" : "max-w-[200px] rounded-lg border border-gray-200"} block"></div>`;
            }
            if (text) {
                if (role === 'user') contentHtml += `<div class="user-bubble p-3.5 rounded-2xl rounded-tr-none text-sm md:text-base shadow-md prose prose-invert">${marked.parse(text)}</div>`;
                else contentHtml += `<div class="bg-white/90 text-gray-800 p-3.5 rounded-2xl rounded-tl-none shadow-sm border border-white/50 prose text-sm md:text-base backdrop-blur-sm">${marked.parse(text)}</div>`;
            }
            if (role === 'bot') {
                wrapper.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-[#0054a6] flex-shrink-0 flex items-center justify-center text-white text-xs font-bold shadow-md ring-2 ring-white">AI</div>
                    <div class="flex flex-col gap-1 max-w-[85%]">
                        <span class="text-xs text-gray-600 ml-1 font-semibold">Assistant</span>
                        ${contentHtml}
                        <button onclick="speakText(this)" class="self-start text-gray-400 hover:text-[#0054a6] text-xs flex items-center gap-1 mt-1 transition px-2 py-1 rounded hover:bg-white/50 font-medium">
                            <i class="ph ph-speaker-high text-lg"></i> Listen
                        </button>
                    </div>`;
            } else {
                wrapper.classList.add('flex-row-reverse');
                wrapper.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-gray-200 flex-shrink-0 flex items-center justify-center text-gray-500 shadow-inner"><i class="ph ph-user text-lg"></i></div>
                    <div class="flex flex-col gap-1 items-end max-w-[85%]">${contentHtml}</div>`;
            }
            chatHistory.appendChild(wrapper); chatHistory.scrollTo({ top: chatHistory.scrollHeight, behavior: 'smooth' });
        }

        function appendLoading() {
            const id = 'loading-' + Date.now();
            const div = document.createElement('div'); div.id = id; div.className = 'flex gap-4 mb-4';
            div.innerHTML = `<div class="w-8 h-8 rounded-full bg-[#0054a6] flex-shrink-0 flex items-center justify-center text-white text-xs font-bold shadow-md ring-2 ring-white">AI</div><div class="flex flex-col gap-1"><span class="text-xs text-gray-600 ml-1">Assistant</span><div class="bg-white/80 p-4 rounded-2xl rounded-tl-none shadow-sm border border-white/50 flex items-center"><div class="dot-flashing mx-4"></div></div></div>`;
            chatHistory.appendChild(div); chatHistory.scrollTo({ top: chatHistory.scrollHeight, behavior: 'smooth' }); return id;
        }
        function removeLoading(id) { const el = document.getElementById(id); if (el) el.remove(); }
        function clearChat() { chatHistory.innerHTML = ''; }
        async function generateContentWithRetry(p, i, m) {
            for (let k = 0; k <= 2; k++) { try { return await callGemini(p, i, m); } catch (e) { if (k===2) throw e; await new Promise(r => setTimeout(r, 1000 * Math.pow(2, k))); } }
        }
        async function callGemini(text, b64, mime) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const parts = [{ text: text }]; if (b64) parts.push({ inline_data: { mime_type: mime, data: b64 } });
            const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts }], systemInstruction: { parts: [{ text: "You are a helpful AI assistant for Narayana Schools." }] } }) });
            if (!response.ok) throw new Error(response.status);
            const res = await response.json(); return res.candidates?.[0]?.content?.parts?.[0]?.text || "Error.";
        }
        window.onload = () => userInput.focus();
    </script>
</body>
</html>